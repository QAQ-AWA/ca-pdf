# ca-pdf 中文用户手册
> 📖 **文档导航**：[README](./index.md) · [文档索引](./DOCUMENTATION.md) · [API 文档](./API.md) · [故障排查](./TROUBLESHOOTING.md)
> 🎯 **适用人群**：业务用户 / 管理员
> ⏱️ **预计阅读时间**：20 分钟

**项目地址**：[https://github.com/QAQ-AWA/ca-pdf](https://github.com/QAQ-AWA/ca-pdf)
**联系邮箱**：[7780102@qq.com](mailto:7780102@qq.com)

本指南面向最终用户，帮助完成证书管理与 PDF 签章流程。若需了解系统背景，请回到 [README.md](./index.md)；自动化或集成需求请阅读 [API.md](./API.md)；遇到问题请参阅 [TROUBLESHOOTING.md](./TROUBLESHOOTING.md)。

---

> 适用版本：v1.0  
> 文档目标：指导系统管理员、普通业务用户和运维团队高效、安全地使用 ca-pdf 自托管电子签章平台。

---

## 1. 手册概览

### 面向人群
- **系统管理员**：负责证书体系、用户权限、审计追踪和整体安全策略。
- **普通用户**：申请证书、执行单份或批量 PDF 签章、完成验签等日常操作。
- **运维人员**：部署维护平台、处理导出数据、协助排障。

### 使用场景
企业合同审批、对外协议签署、内部文件确认、合规归档、跨部门协同以及任何需要生成、验证具法律效力 PDF 签章的流程。

### 快速导航
| 模块 | 说明 |
| ---- | ---- |
| [账户与认证](#2-账户与认证) | 登录、登出、令牌刷新、密码重置、角色说明 |
| [证书管理](#3-证书管理) | 生成根 CA、签发/导入证书、列表查询、吊销、CRL 管理 |
| [PDF 电子签章](#4-pdf-电子签章) | 上传、参数配置、印章管理、单份/批量签署、预览下载 |
| [签章验真](#5-签章验真) | 验签流程、结果判读、常见问题 |
| [审计日志](#6-审计日志-管理员) | 日志结构、筛选、分页、导出 |
| [用户管理](#7-用户管理-管理员) | 用户生命周期、权限控制、批量导入 |
| [数据导出](#8-数据导出) | 审计、证书、签章记录导出渠道 |
| [常见场景教程](#9-常见场景教程) | 5 个典型业务流程拆解 |
| [常见问题](#10-常见问题解答-faq) | 证书/签章/验签/用户管理热点问题 |
| [快捷键与技巧](#11-快捷键与技巧) | 提效方法、小贴士 |

---

## 2. 账户与认证

### 2.1 登录
1. 打开前端地址（示例：`https://app.localtest.me`）。
2. 输入注册邮箱与密码，提交后进入仪表盘。
3. 首次登录请立即在“用户管理”请求管理员重置密码。

### 2.2 登出
点击右上角头像按钮 → 选择“登出”即可立即清除当前访问令牌与刷新令牌。

### 2.3 令牌刷新
- 平台采用 **Access Token + Refresh Token** 双令牌机制。
- 访问令牌默认 15 分钟过期，刷新令牌默认 3 天过期。
- 前端在访问令牌即将失效时自动向 `/auth/refresh` 请求新令牌，旧刷新令牌会被立即吊销。

### 2.4 密码重置
普通用户无法自助修改密码。如遗失密码：
1. 联系管理员在“用户管理”中选中目标账号。
2. 点击“重置密码”，填写新密码并确认。
3. 用户使用临时密码登录后应再次联系管理员生成新的强密码。

### 2.5 权限等级
| 角色 | 主要权限 |
| ---- | -------- |
| **User** | 签发/导入个人证书、执行签章、验签、查看个人日志片段 |
| **Admin** | 拥有 User 全部权限，额外管理用户、吊销证书、生成 CRL、查看完整审计日志、维护印章资源 |

---

## 3. 证书管理

### 3.1 生成根 CA（管理员）
1. 访问“证书管理”页，若系统尚无根 CA，页面将自动展示生成向导。
2. 填写必填字段：通用名称（CN）、组织（O）、国家（C）、有效期（天）。
3. 选择算法：RSA-4096 或 EC-P256。RSA 兼容性最佳，EC 性能更优。
4. 点击“生成根 CA”，完成后系统会提示下载根证书与密钥备份。
5. 建议将根 CA 证书导入企业所有 PDF 阅读器的受信任列表。

### 3.2 签发用户证书
1. 在“签发证书”卡片填写 CN、O、Email、有效期、算法。
2. 提交后系统生成带私钥的 PKCS#12 文件（.p12 或 .pfx）。
3. 下载文件并记录生成的证书序列号（即证书 ID），后续签章需使用。

### 3.3 PKCS#12 格式说明
- 内含用户证书、私钥及根证书链；
- 受随机密码保护，页面会显示密码提示；
- 建议放入密码管理器并离线备份。

### 3.4 导入外部证书
1. 切换至“导入证书”卡片，上传 `.p12/.pfx` 文件。
2. 输入原证书密码并提交。
3. 系统验证通过后显示“导入成功”提示并刷新列表。
4. 支持的证书须包含 End-Entity 证书与私钥；如证书已过期会被标记为“Expired”。

### 3.5 查看证书列表
- 列表字段：序列号、主体名称、邮箱、签发时间、过期时间、状态（Active/Revoked/Expired/Pending）。
- 顶部搜索框支持按序列号、主体关键字模糊查询，列表右上角可选择状态过滤并按过期时间排序。
- 普通用户仅能看到自己的证书；管理员可查看所有用户证书。

### 3.6 吊销证书
1. 在列表中定位目标证书，点击“吊销”。
2. 填写吊销理由（示例：证书泄露、用户离职）。
3. 确认操作后状态变更为“Revoked”，吊销时间记录入审计日志。

### 3.7 CRL 管理
- 点击“生成 CRL”可随时刷新吊销列表，系统会自动下载最新 CRL 文件。
- 历史 CRL 会显示名称、生成时间、包含的序列号数量，可再次下载。

---

## 4. PDF 电子签章

### 4.1 签章工作台结构
- **文件队列**：展示待签章的 PDF 列表。
- **签章参数面板**：配置证书 ID、印章、可见性、元数据、时间戳等参数。
- **PDF 预览**：实时拖拽定位签章位置，支持放大缩小。

### 4.2 上传文件
- 支持单个或批量（≤10 个）PDF，单文件最大 50 MiB。
- 批量上传后文件按队列顺序处理，可随时移除某个文件。

### 4.3 配置签章参数
| 配置项 | 说明 |
| ------ | ---- |
| 证书 ID | 必填，填写证书序列号；建议从证书列表复制粘贴以避免错误。
| 签章可见性 | 可见：PDF 中出现签名框；不可见：仅写入数字签名，不改变页面。
| 页码/位置 | 可见签章需指定页码；在预览区拖动或输入具体坐标和宽高（单位：点）。
| 签章元数据 | 可选填写理由、地点、联系方式，信息会写入 PDF 签名属性。
| 时间戳（TSA） | 勾选后系统向已配置的 TSA 发送请求，获得可信时间。
| LTV 嵌入 | 将 OCSP/CRL 响应写入签名，便于长期离线验证。

### 4.4 企业印章
1. 管理员在“印章管理”上传 PNG/SVG 图片（≤1 MiB）。
2. 印章上传后自动生成编号，支持批量管理、启用/停用。
3. 普通用户在签章面板的“印章”下拉框中选择需要的企业印章，实现契约式签章外观。

### 4.5 单份签章流程
1. 上传 PDF → 选择证书 → 添加签名覆盖层。
2. 设定页码与位置 → 选择印章、填写理由。
3. （可选）勾选 TSA、LTV。
4. 点击“签署”，完成后浏览器自动下载 `<原文件名>_signed.pdf`。

### 4.6 批量签章
- 上传多份文件后，可对第一份配置参数并应用于全体。
- 系统逐份执行签署，进度条展示当前进度；即使某一文件失败，其他文件继续处理。

### 4.7 签章预览
- 可见签章在预览区实时展示印章与签名信息。
- 调整尺寸时建议保持 16:9 或 4:3 比例，确保印章清晰。
- 点击“预览模式”可查看最终成品效果。

---

## 5. 签章验真

### 5.1 操作流程
1. 打开“验签工作台”，点击“选择文件”上传已签章 PDF。
2. 上传后系统解析所有签名域，生成验证摘要与详细报告。
3. 每个签名条目展示：有效性、信任链、时间戳、签署人、签章原因、文档修改状态（DocMDP）。

### 5.2 结果判读
- **签名有效性**：Valid（绿色）表示自签署以来文档未被修改；Invalid（红色）表示存在篡改；Unknown（黄色）表示无法识别。
- **信任链**：Trusted 表示证书链可追溯至平台根 CA；Untrusted 需导入对应根证书。
- **时间戳**：展示是否来自可信 TSA，以及签署具体时间。
- **LTV 状态**：标识是否嵌入 OCSP/CRL，可长期离线验证。

### 5.3 常见问题
- 验签失败多因文件签后被编辑或证书已吊销。
- 若提示“不受信任”，请导入根 CA 证书或联系管理员确认证书来源。
- 系统暂不支持批量验签，如需大量验证可调用 REST API。

---

## 6. 审计日志（管理员）

### 6.1 页面入口
导航栏选择“审计日志”进入。只有管理员账号能访问该页面。

### 6.2 字段说明
| 字段 | 含义 |
| ---- | ---- |
| 时间戳 | 精确到毫秒的操作时间 |
| 事件类型 `event_type` | 如 `user.login`、`certificate.issued`、`pdf.signature.applied` |
| 资源标识 `resource` | 关联对象（证书 ID、PDF 记录、印章 ID 等）|
| 操作人 `actor_id` | 触发操作的账号 ID，系统任务显示为 system |
| IP / User-Agent | 来源主机与客户端信息 |
| 元数据 | JSON 格式的额外参数，如证书序列号、文件名 |

### 6.3 查询与过滤
- 顶部表单支持按事件类型、用户 ID、起止日期过滤。
- 支持组合筛选与关键字搜索，便于快速锁定关键操作。
- 列表底部分页控件可翻页查看历史记录，单页默认 100 条。

### 6.4 导出
- 点击“导出 CSV”获取表格数据，适合 Excel 分析。
- 点击“导出 JSON”获取结构化数据，用于脚本处理或归档。
- 导出文件会附带生成时间与当前筛选条件，便于审计留痕。

---

## 7. 用户管理（管理员）

### 7.1 查看与筛选
- 页面展示邮箱、角色、状态、创建时间等字段。
- 支持关键词搜索用户邮箱/姓名，支持角色（User/Admin）与状态（Active/Inactive）过滤。
- 分页控件支持快速跳转，默认每页 10 条。

### 7.2 创建用户
1. 点击“创建用户”，填写邮箱、初始密码、角色、是否启用。
2. 提交后系统立即发送成功提示，用户可使用该凭据登录。

### 7.3 编辑与权限调整
- 在用户行点击“编辑”可修改邮箱、角色、启用状态。
- 支持一键启用/禁用，无需重新创建账号。

### 7.4 重置密码
- 点击“重置密码”，输入新密码并确认。
- 重置操作会记录到审计日志，用户得到新密码后应尽快更新。

### 7.5 删除用户
- 点击“删除”永久移除账号，历史签章/日志仍保留。
- 建议优先使用“禁用”，避免误删影响审计可追溯性。

### 7.6 批量导入
- 下载模板 CSV，字段为 `email,password,role,is_active`。
- 填写后在页面点击“批量导入”，系统自动校验格式并提示成功/失败条目。

---

## 8. 数据导出
- **审计日志**：在“审计日志”页导出 CSV/JSON，用于合规审查。
- **证书列表**：在“证书管理”页点击“导出证书”，获取当前筛选后的证书明细。
- **签章记录**：在“审计日志”中筛选 `pdf.signature.applied` 并导出即可获得签章活动报表。

---

## 9. 常见场景教程

### 场景 1：新人申请证书并完成首个签章
1. 登录系统 → 进入“证书管理”签发个人证书 → 下载 PKCS#12 → 记录序列号。
2. 切换到“签章工作台”上传 PDF → 输入证书 ID → 配置可见签章位置 → 勾选 TSA（如需） → 签署并下载。

### 场景 2：管理员批量创建新员工账户
1. 准备包含邮箱、临时密码、角色的 CSV。
2. 在“用户管理”执行批量导入 → 成功后为用户分配证书 → 提醒首次登录后重置密码。

### 场景 3：审核人员验证合作伙伴发来的签章文件
1. 打开“验签工作台”上传 PDF。
2. 查看每个签名的有效性、信任链与时间戳。
3. 如显示“不受信任”，导入对方根证书或联系对方确认。

### 场景 4：企业统一维护印章并在合同上应用
1. 管理员在“印章管理”上传公章、合同章等模板。
2. 业务人员签署合同时在签章面板选择对应印章，实现统一视觉效果。
3. 若印章更新，上传新版本并停用旧版本，确保审计可追踪。

### 场景 5：合规专员导出本季度操作记录
1. 在“審計日志”按季度设置时间范围并筛选关键事件。
2. 导出 CSV/JSON → 使用 Excel 或脚本统计关键指标。
3. 附上报告提交给审计/法务部门存档。

---

## 10. 常见问题解答 (FAQ)

### 证书
- **证书 ID 在哪里查看？** 证书列表第一列即序列号，同时在下载的证书包信息中也可查看。
- **证书过期处理？** 重新签发新证书即可，旧签名仍然有效。
- **PKCS#12 密码遗失？** 无法恢复，只能重新签发证书。

### 签章
- **签章失败常见原因？** 证书 ID 填写错误、证书已吊销、PDF 超过大小限制、TSA 无法访问、可见签章未配置坐标。
- **可以多次签章吗？** 可，多人顺序签署同一文档时会生成多条签名记录。
- **签章后文件变大？** 属正常现象，因嵌入签名数据、印章、时间戳与 LTV 材料。

### 验签
- **显示“不受信任”？** 导入根 CA 或联系签署方确认证书来源。
- **证书已过期但签名仍有效？** 若签署时证书有效且有可信时间戳，验签会返回有效。
- **可否批量验签？** 图形界面暂不支持，可通过 API 实现自动化。

### 用户管理
- **普通用户能修改密码吗？** 目前需管理员协助重置。
- **禁用与删除差异？** 禁用保留数据可恢复，删除不可逆但历史记录仍在。
- **管理员能代签其他人？** 技术上可行但不推荐，建议每人使用各自证书确保不可否认性。

---

## 11. 快捷键与技巧
- **批量上传 PDF**：在文件选择器中按住 `Ctrl/Cmd` 多选，可一次添加多份文件。
- **键盘导航**：`Tab` 快速切换表单字段，`Enter` 提交当前操作对话框，`Esc` 关闭弹窗。
- **批量操作提示**：利用签章队列、一键导出、批量导入用户等功能，可显著缩短重复工作时间。

---

> 如需进一步技术支持或希望扩展功能，请联系运维团队或在内部工单系统提交需求。祝您使用顺利，持续构建可信的电子签章流程。
---

🔗 **相关文档**
- [README](./index.md)
- [API 文档](./API.md)
- [部署手册](./DEPLOYMENT.md)
- [故障排查](./TROUBLESHOOTING.md)

❓ **需要帮助？**
- 请查看 [TROUBLESHOOTING.md](./TROUBLESHOOTING.md)

